# 背景
文件名：2025-01-27_1_debt_cleanup_execution.md
创建于：2025-01-27_10:30:00
创建者：Claude
主分支：main
任务分支：task/hardcoded_import_fix_20250721
Yolo模式：Ask

# 任务描述
启动技术债务清理项目的具体执行阶段，重点解决硬编码导入问题和关键架构债务，提升代码质量和可维护性。

# 项目概览
游戏自动化工具项目，基于Clean Architecture架构，当前存在严重技术债务：
- 总问题数：407个
- Critical问题：58个
- Major问题：349个
- 硬编码导入问题：256个
- 预估修复时间：443.5小时

⚠️ 警告：永远不要修改此部分 ⚠️
核心RIPER-5协议规则：
- 必须在每个响应开头声明当前模式
- 在EXECUTE模式中必须100%忠实遵循计划
- 在REVIEW模式中必须标记即使最小的偏差
- 未经明确许可不能在模式之间转换
- 代码修改必须包含完整上下文和适当错误处理
⚠️ 警告：永远不要修改此部分 ⚠️

# 分析

## 当前项目状态

### Git分支状态
- 当前分支：`task/hardcoded_import_fix_20250721`
- 相关分支：`task/debt_cleanup_20250120_1`
- 主分支：`main`
- 最新提交：`ec563e0 feat: 完成系统性技术改进项目`

### 已有债务清理资源
1. **债务分析报告**：`debt_analysis_report.md` - 详细的问题统计和分析
2. **清理计划**：`cleanup_plan_high.json` - 高优先级任务清单
3. **进度数据库**：`debt_cleanup_progress.db` - SQLite数据库跟踪进度
4. **硬编码导入修复计划**：`hardcoded_import_fix_plan_20250721.md` - 专项修复计划

### 硬编码导入问题分析
通过正则搜索发现的`from src.`模式导入分布：

#### 主要问题文件
1. **核心容器文件**：
   - `src/application/containers/main_container.py` - 11个硬编码导入
   - 影响整个依赖注入系统

2. **测试文件**：
   - 大量测试文件包含硬编码导入
   - 影响测试的可移植性和独立性

3. **游戏适配器**：
   - `src/games/zzz/zzz_adapter.py` - 包含win32相关导入
   - 其他游戏适配器也存在类似问题

4. **文档和示例**：
   - 文档中的代码示例包含硬编码导入
   - 可能误导开发者

#### 导入模式统计
- `from src.core.` - 核心模块导入（最高优先级）
- `from src.common.` - 通用模块导入（高优先级）
- `from src.services.` - 服务层导入（中优先级）
- `from src.application.` - 应用层导入（中优先级）
- `from src.infrastructure.` - 基础设施层导入（低优先级）
- `from src.gui.` - 界面层导入（低优先级）

### 关键技术债务问题

#### 🔴 Critical级别问题
1. **硬编码导入依赖**（256个问题）
   - 破坏模块化架构
   - 阻碍测试和重构
   - 降低代码可移植性

2. **容器反模式**（28个问题）
   - 服务定位器伪装成DI容器
   - 依赖关系隐藏
   - 生命周期管理混乱

3. **长方法问题**（93个问题）
   - 代码可读性差
   - 测试困难
   - 维护成本高

4. **上帝类问题**（30个问题）
   - 违反单一职责原则
   - 耦合度过高
   - 扩展性差

## 风险评估

### 高风险区域
1. **主容器文件**：`src/application/containers/main_container.py`
   - 影响整个应用启动
   - 修改需要极其谨慎

2. **核心游戏适配器**：
   - 直接影响游戏功能
   - 包含平台特定代码（如win32）

3. **配置系统**：
   - 影响全局配置访问
   - 可能导致运行时错误

### 缓解策略
1. **渐进式修复**：从叶子节点开始，逐步向核心推进
2. **充分测试**：每个修复后立即验证
3. **备份机制**：保持详细的修改记录
4. **回滚准备**：确保可以快速回滚

# 提议的解决方案

## 执行策略：分阶段渐进式修复

### 阶段1：准备和基础修复（当前阶段）
**目标**：建立修复基础，处理低风险文件

**优先级1：测试文件修复**
- 修复所有测试文件中的硬编码导入
- 建立测试基准
- 验证修复效果

**优先级2：文档和示例修复**
- 更新文档中的代码示例
- 确保开发指南的正确性

**优先级3：工具和脚本修复**
- 修复tools目录下的脚本
- 更新构建和部署脚本

### 阶段2：服务层修复
**目标**：修复服务层的导入问题

**优先级1：通用服务**
- `src/services/config.py`
- `src/services/logger.py`
- `src/services/error_handler.py`

**优先级2：业务服务**
- 游戏分析服务
- 图像处理服务
- 窗口管理服务

### 阶段3：核心架构修复
**目标**：修复核心架构组件

**优先级1：接口定义**
- `src/core/interfaces/`目录下的文件

**优先级2：容器系统**
- `src/application/containers/main_container.py`
- 依赖注入配置

### 阶段4：应用层修复
**目标**：修复应用层和表示层

**优先级1：用例实现**
- `src/core/use_cases/`目录

**优先级2：GUI组件**
- 界面相关文件
- 现代UI组件

### 阶段5：游戏适配器修复
**目标**：修复游戏特定代码

**优先级1：通用适配器**
- `src/games/game_base.py`

**优先级2：具体游戏适配器**
- ZZZ适配器
- 其他游戏适配器

## 技术实施方案

### 相对导入转换规则
1. **同级模块**：`from .module import Class`
2. **父级模块**：`from ..parent import Class`
3. **子级模块**：`from .subdir.module import Class`
4. **跨层级**：根据目录结构计算相对路径

### 特殊处理策略
1. **入口文件**：保持绝对导入或使用sys.path
2. **测试文件**：使用pytest的导入机制
3. **平台特定代码**：考虑抽象化处理

### 验证机制
1. **语法检查**：确保导入语法正确
2. **功能测试**：运行现有测试套件
3. **集成测试**：验证应用启动和基本功能
4. **性能测试**：确保修复不影响性能

# 当前执行步骤："1. 启动债务清理执行阶段"

# 任务进度
[2025-01-27_10:30:00]
- 已修改：创建债务清理执行任务文件
- 更改：建立当前阶段的详细执行计划
- 原因：基于现有分析制定具体的修复策略
- 阻碍因素：无
- 状态：待确认

# 最终审查
[待完成]